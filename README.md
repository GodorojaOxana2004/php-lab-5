# Отчет по лабораторной работе №5. Работа с базой данных

## Описание лабораторной работы

Лабораторная работа №5 посвящена освоению архитектуры веб-приложения с единой точкой входа, внедрению системы шаблонов для визуализации страниц и переходу от хранения данных в файле к использованию базы данных SQLite (вместо MySQL, указанного в условии, для упрощения настройки). Проект "Система управления задачами", начатый в лабораторной работе №4, был доработан для выполнения следующих задач:

1. Реализация единой точки входа через `public/index.php` с простой маршрутизацией.
2. Внедрение системы шаблонов с базовым шаблоном `templates/layout.php` и отдельными представлениями для страниц.
3. Перенос хранения данных из файла `tasks.txt` в базу данных SQLite (`storage/tasks.db`).
4. Реализация CRUD-функциональности (создание, чтение, обновление, удаление задач).
5. Защита от SQL-инъекций с использованием подготовленных выражений PDO.
6. Сохранение пагинации с использованием SQL-запросов `LIMIT` и `OFFSET`.

Проект позволяет добавлять, редактировать, удалять и просматривать задачи, отображать последние две задачи на главной странице и полный список задач с пагинацией (5 задач на страницу). Динамическое управление шагами выполнения задачи реализовано через JavaScript.

---

## Инструкции по запуску проекта

1. **Установите PHP**  
   Убедитесь, что на вашем компьютере установлен PHP версии 7.4 или выше. SQLite обычно включен в PHP по умолчанию. Скачать PHP можно с [официального сайта](https://www.php.net/downloads).

2. **Скачайте проект**  
   Скопируйте файлы проекта в любую директорию, например, `task-manager`.

3. **Создайте базу данных SQLite**  
   Создайте файл `storage/init.sql` со следующим содержимым для инициализации базы данных:
   ```sql
   CREATE TABLE categories (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       name TEXT NOT NULL UNIQUE,
       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );

   CREATE TABLE tasks (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       title TEXT NOT NULL,
       category_id INTEGER NOT NULL,
       description TEXT,
       tags TEXT,
       steps TEXT,
       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
       FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
   );

   INSERT INTO categories (name) VALUES ('работа'), ('личное'), ('срочное');
   ```
   Выполните команду в терминале для создания базы `storage/tasks.db`:
   ```bash
   sqlite3 storage/tasks.db < storage/init.sql
   ```

4. **Перейдите в директорию `public`**  
   Откройте терминал и выполните:
   ```bash
   cd public
   ```

5. **Запустите локальный сервер**  
   Выполните команду:
   ```bash
   php -S localhost:8080
   ```

6. **Откройте приложение в браузере**  
   Перейдите по адресу:
   ```
   http://localhost:8080
   ```

---

## Краткая документация к проекту

### Структура проекта
```
task-manager/
├── public/
│   ├── index.php                  # Единая точка входа
│   └── js/
│       └── script.js              # JavaScript для динамических шагов
├── src/
│   ├── handlers/
│   │   ├── task/
│   │   │   ├── create.php         # Обработчик добавления задачи
│   │   │   ├── edit.php           # Обработчик редактирования задачи
│   │   │   └── delete.php         # Обработчик удаления задачи
│   ├── db.php                     # Подключение к SQLite
│   └── helpers.php                # Вспомогательные функции
├── config/
│   └── db.php                     # Конфигурация базы данных
├── templates/
│   ├── layout.php                 # Базовый шаблон
│   ├── index.php                  # Главная страница (2 последние задачи)
│   └── task/
│       ├── create.php             # Форма добавления задачи
│       ├── edit.php               # Форма редактирования задачи
│       └── show.php               # Список задач с пагинацией
├── storage/
│   └── tasks.db                   # SQLite база данных
└── README.md                      # Документация
```

### Описание файлов
- **`public/index.php`**: Единая точка входа, обрабатывающая все HTTP-запросы через маршрутизацию.
- **`templates/layout.php`**: Базовый шаблон, включающий общую разметку и навигацию.
- **`templates/index.php`**: Шаблон главной страницы, отображающий две последние задачи.
- **`templates/task/show.php`**: Шаблон списка задач с пагинацией.
- **`templates/task/create.php`**: Форма для добавления новой задачи.
- **`templates/task/edit.php`**: Форма для редактирования существующей задачи.
- **`src/handlers/task/*.php`**: Обработчики для создания, редактирования и удаления задач.
- **`src/db.php`**: Функция подключения к базе данных SQLite с использованием PDO.
- **`src/helpers.php`**: Вспомогательные функции для работы с формами.
- **`config/db.php`**: Конфигурация подключения к базе данных.
- **`public/js/script.js`**: JavaScript для динамического добавления и удаления шагов выполнения.

### Основные функции
- **CRUD-операции**: Создание, просмотр, редактирование и удаление задач.
- **Пагинация**: Отображение списка задач по 5 на страницу с использованием `LIMIT` и `OFFSET`.
- **Шаблонизация**: Разделение логики и представления с помощью PHP-шаблонов.
- **Безопасность**: Фильтрация входных данных через `filter_input()` и защита от SQL-инъекций с помощью подготовленных выражений PDO.

---

## Примеры использования проекта

### 1. Добавление задачи
Перейдите по ссылке "Добавить задачу" (`/task/create`). Заполните форму, выберите категорию, добавьте тэги и шаги выполнения. Пример формы:

![Скриншот формы добавления задачи](screenshots/create_task.png)

**Фрагмент кода формы (`templates/task/create.php`)**:
```php
<form method="POST" action="/task/create">
    <div>
        <label>Название:</label><br>
        <input type="text" name="title" value="<?= getFormValue('title') ?>">
        <?php if (isset($errors['title'])): ?>
            <p class="error"><?= $errors['title'] ?></p>
        <?php endif; ?>
    </div>
    <div>
        <label>Шаги:</label><br>
        <div id="steps">
            <div class="step">
                <textarea name="steps[]" rows="2"></textarea>
                <span class="remove-step">Удалить</span>
            </div>
        </div>
        <button type="button" id="add-step">Добавить шаг</button>
    </div>
    <button type="submit">Сохранить</button>
</form>
```

### 2. Просмотр списка задач
Перейдите по ссылке "Все задачи" (`/tasks`). Список отображает задачи с пагинацией.

![Скриншот списка задач](screenshots/task_list.png)

**Фрагмент кода пагинации (`public/index.php`)**:
```php
$stmt = $pdo->prepare('SELECT t.*, c.name as category_name 
                       FROM tasks t 
                       JOIN categories c ON t.category_id = c.id 
                       ORDER BY t.created_at DESC 
                       LIMIT :limit OFFSET :offset');
$stmt->bindValue(':limit', $perPage, PDO::PARAM_INT);
$stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
$stmt->execute();
```

### 3. Редактирование задачи
На странице списка задач нажмите "Редактировать" для задачи. Форма редактирования автоматически заполняется данными задачи.

**Фрагмент кода формы редактирования (`templates/task/edit.php`)**:
```php
<form method="POST" action="/task/edit?id=<?= $task->id ?>">
    <div>
        <label>Название:</label><br>
        <input type="text" name="title" value="<?= htmlspecialchars($task->title) ?>">
    </div>
    <div>
        <label>Категория:</label><br>
        <select name="category_id">
            <?php foreach ($categories as $category): ?>
                <option value="<?= $category->id ?>" <?= $task->category_id == $category->id ? 'selected' : '' ?>>
                    <?= htmlspecialchars($category->name) ?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>
</form>
```

---

## Ответы на контрольные вопросы

1. **Какие преимущества даёт использование единой точки входа в веб-приложении?**  
   - Централизованная обработка всех запросов упрощает управление маршрутизацией.  
   - Легче внедрять глобальные настройки, такие как подключение к базе данных или обработка ошибок.  
   - Упрощает обеспечение безопасности, например, проверку авторизации на одном уровне.  

2. **Какие преимущества даёт использование шаблонов?**  
   - Повторное использование кода: общая разметка (навигация, стили) задается в одном файле (`layout.php`).  
   - Разделение логики и представления улучшает читаемость и поддержку кода.  
   - Упрощение изменений дизайна: достаточно изменить шаблон, а не каждую страницу.  

3. **Какие преимущества даёт хранение данных в базе по сравнению с хранением в файлах?**  
   - Быстрый доступ и поиск данных с помощью SQL-запросов.  
   - Поддержка сложных связей между данными (например, внешние ключи для категорий).  
   - Масштабируемость и надежность: базы данных лучше справляются с большими объемами данных.  
   - Транзакции и обеспечение целостности данных.  

4. **Что такое SQL-инъекция? Придумайте пример SQL-инъекции и объясните, как её предотвратить.**  
   - **SQL-инъекция**: Вредоносный ввод, который позволяет злоумышленнику выполнить нежелательные SQL-запросы.  
   - **Пример**: Если поле `title` принимает ввод `' OR '1'='1`, запрос `SELECT * FROM tasks WHERE title = '$title'` станет `SELECT * FROM tasks WHERE title = '' OR '1'='1'`, возвращая все записи.  
   - **Предотвращение**: В проекте используются подготовленные выражения PDO. Например:
     ```php
     $stmt = $pdo->prepare('INSERT INTO tasks (title, category_id) VALUES (:title, :category_id)');
     $stmt->execute(['title' => $title, 'category_id' => $category_id]);
     ```
     Это экранирует ввод и предотвращает выполнение вредоносного кода.

---

## Список использованных источников

1. Официальная документация PHP: [https://www.php.net/manual/ru/](https://www.php.net/manual/ru/)  
2. Документация SQLite: [https://www.sqlite.org/docs.html](https://www.sqlite.org/docs.html)  
3. Условие лабораторной работы на GitHub.  
4. Лекционные материалы курса.  
5. Документация MDN по JavaScript: [https://developer.mozilla.org/ru/docs/Web/JavaScript](https://developer.mozilla.org/ru/docs/Web/JavaScript)  

---

## Дополнительные важные аспекты

- **SQLite вместо MySQL**: SQLite выбран для упрощения настройки, так как не требует установки сервера базы данных. Он поддерживает все необходимые функции, включая внешние ключи.  
- **Пагинация**: Реализована с использованием SQL-запросов `LIMIT` и `OFFSET`, отображая по 5 задач на страницу.  
- **Документация кода**: Все функции задокументированы с использованием PHPDoc, включая описание параметров и возвращаемых значений.  
- **Безопасность**:  
  - Фильтрация входных данных через `filter_input()`.  
  - Экранирование вывода с помощью `htmlspecialchars()`.  
  - Защита от SQL-инъекций через подготовленные выражения PDO.  
- **Динамические шаги**: JavaScript позволяет добавлять и удалять шаги выполнения задачи, сохраняя интерактивность интерфейса.  
- **Ошибки**: В процессе разработки была исправлена ошибка в `public/index.php` (опечатка `$content.s` вместо `$content`), что обеспечило корректную работу маршрутизации.